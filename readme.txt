#picture セットアップ方法
  作成日 2016年12月31日
  作成者 北村 成吏(せいじ)

#はじめに
  Webカメラを使用して定点観測をします。
  PCに接続されているカメラ台数分だけ指定した時間に写真を撮影し、
  定められたファイルサーバーに自動で送信します。

  なおPCはRaspberry Pi3を想定しています。

#セットアップ
  #OS
    OSのインストールはインターネットを参照してください。
   軽快に動作する「raspbian」をおすすめします。

  #raspbianの設定
    別紙「Raspberry Pi セットアップ」を参照してください。

  #picture
    ターミナルから以下のコマンドを実行
      cd
      git clone git@172.16.0.13:/home/git/picture.git
      (パスワードはgit)

#インストール
  ターミナルから以下のコマンドを実行するとインストールされます。
    cd
    ./picture/setup.sh

#インストール後
  ファイルサーバーへ写真を送信する場合には以下の作業が残っています。
  #scpserver.iniの設定
    picture/scpserver.iniを開いて設定を保存してください。
      FILESERVER=               #ファイルサーバーアドレス
      SCPUSER=                  #ファイルサーバーへのログインID
      DIR=                      #ファイルサーバー上のPath

  #SSH公開キー
    picture/scpserver.iniで登録した送信先サーバーに
    このPCの公開キーを送信して登録してください。
    詳しくはインターネットで「SSH公開キー」を検索すると出てきます。

#詳細
  #setup.sh
    以下の作業を実施します。
      必要なパッケージのインストール
        fswebcam apache2

      apache設定
        conf/picture.confをコピーしてブラウザから写真を確認できるようにします。
        ブラウザで「IPアドレス/img」と打ち込むと写真が確認できます。

      scpserver.ini
        scpserver.ini.defaultをscpserver.iniにコピーします。
        scpserver.iniの詳細については以下を参照してください。

      cron(conf/cron.txt)
        実行ユーザーのcronに撮影スケジュールを登録します。詳細は以下のcron.txt
        を参考にしてください。

      cron(conf/reboot.txt)
        定時にPCを再起動させます。fswebcamを使用していると稀にプログラムがカメラ
        を掴んだままになり撮影できない場合が起こります。 それを回避するために1日1回
        再起動をかけています。デフォルトでは以下のスケジュールとなっています。
          毎日午前0時

        再起動を望まないもしくは時間を変更したい場合には「sudo crontab -e」と入力
        して修正してください。
        (crontab -eの詳しい説明はインターネットで検索してください)

      SSHキー作成
        /home/ユーザー名/.sshに「id_rsa.pub」がない場合、キーを作成します。
        特にこだわりがなければエンターキー空打ちを続けると作成されいます。

  #picture.sh
    /dev/video[*]の台数分だけ静止画を撮影します。
    撮影後はimgディレクトリに「DAY年月日_video[*].jpg」という名前で
    保存されます。その後、ファイルサーバーへの送信を行います。

    変数
      SLEEPTIME
        1つのカメラを撮影してから次のカメラに移るまでの時間（秒）。
        0にすると稀に「device busy」となり撮影に失敗します。
        ex)
          #SLEEPTIME=3でカメラ4台接続されている場合
          video0 撮影後、3秒停止
          video1 撮影後、3秒停止
          video2 撮影後、3秒停止
          video3 撮影後、3秒停止

    使用するファイル
      ini/video_default.ini
        デフォルトのカメラ設定です。詳細はインターネットで
        「fswebcam option」と検索してください。

      ini/video[0-9]*.ini
        カメラごとに設定ファイルを作成することも可能です。
        この場合、/dev/video と ini/video の番号が一致している必要が
        あります。（なければvideo_default.iniが使用されます)

      ini/scpserver[0-9]*.ini
        ファイル送信先の情報を登録するファイルです。送信先を複数台登録
        することも可能でその場合はini/scpserver[任意の番号].iniファイルを
        設置してください。
        ファイル送信を希望しない場合にはこのファイルを削除してください。

  #send.sh
    撮影した写真を再度ファイルサーバーに送信します。
    LAN接続が切れていた等の障害発生に備えて、「何日前」から今日までの
    写真を再送信することが可能です。

    変数
      BACKDAY
        何日前からの写真を再送信の対象とするか0以上の数字を登録します。
        再送信後、ここで指定した日付の写真が削除されます。
          ex)
             #当日の写真を再送信後、当日の写真を削除
             BACKDAY=0

             #3日前から今日までの写真を再送信後、3日前の写真を削除
             BACKDAY=3

    使用するファイル
      ini/scpserver[0-9]*.ini
        ファイル送信先の情報を登録するファイルです。送信先を複数台登録
        することも可能でその場合はini/scpserver[任意の番号].iniファイルを
        設置してください。
        「picture.sh」と同じファイルを使用しています。

    注意点
      ファイル送信に成功しても失敗してもBACKDAYで指定された写真は削除
      されます。

  #cron.txt
    インストール時に自動でcronに追加されます。
    デフォルトでは以下のスケジュールで実行されます。
      picture.sh  毎日午前9時から午後22時までの15分間隔
      send.sh     毎日午後23時

    このスケジュールを変更する場合は、「crontab -e」と入力して変更して
    ください。(crontab -eの詳しい説明はインターネットで検索してください)


  #ログ
    picture.sh、send.shは/var/log/syslogに出力するようにcronで設定し
    てありますので、まずはログはそちらをご覧ください。

    picture.sh内で使用しているfswebcamのログは出力しない設定にしていま
    す。出力したい場合はpicture.sh内fswebcamの「-q」オプションを削除し
    てください。(fswebcamのその他の詳しい設定はインターネットで検索して
    ください。)

#仕様
   #同時撮影不可
     fswebcamは同時に起動し撮影することができません。PCに複数台のカメラ
     が接続されている場合、1台のカメラの撮影が終了してから、次のカメラ
     の撮影が始まります。また1台のカメラの撮影に10秒前後の時間がかかり
     ます。これはピント調整や露出調整の時間も必要なためです。

     仮に1つのPCに10台のカメラが接続されている場合、最初のカメラが撮影
     されてから最後のカメラが撮影されるまで100秒くらいかかることになり
     ます。

   #setup.shの複数回実行
     cronを設定するところで既存のcronを追記して登録をかけています。
     したがって、何らかの理由でsetup.shを複数回実行すると同じスケジュ
     ールが登録されていまうので注意が必要です。
     不安なら「setup.sh」を実行する前にcron部分を削除してください。
